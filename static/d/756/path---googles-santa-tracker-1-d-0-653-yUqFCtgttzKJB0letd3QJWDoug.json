{"data":{"site":{"siteMetadata":{"title":"Natalie's Blog","author":"nataliekate"}},"markdownRemark":{"id":"d59a1c85-be93-5fdc-8da5-0238a8e2de5b","excerpt":"来源：Santa Tracker as a PWA去年圣诞节才知道Google弄了个有趣的小应用，叫Santa Tracker，让你实时跟踪圣诞老人的“去向”。当时就觉得太好玩了。今天无聊看了下Google Developers的前端Case Studies…","html":"<p>来源：<a href=\"https://developers.google.com/web/showcase/2017/santa\">Santa Tracker as a PWA</a></p>\n<p>去年圣诞节才知道Google弄了个有趣的小应用，叫Santa Tracker，让你实时跟踪圣诞老人的“去向”。当时就觉得太好玩了。今天无聊看了下Google Developers的前端Case Studies，发现刚好有一篇关于这个小应用的文章，于是读了一下，希望能汲取大神们的智慧。</p>\n<p>Santa Tracker is an Progressive Web App (PWA) that supports Add to Home Screen (ATHS) and offline. The offline function makes use of the Service Worker API.</p>\n<p>The unique ‘scenes’ on the web version of Santa Tracker is written in <a href=\"https://www.polymer-project.org/\">Polymer 1.7.0</a>, supporting most modern browsers. The app requires ES6 features like <code class=\"language-text\">Set</code> as well as the <strong>Web Performance API</strong>. To decide whether the browser is <em>modern</em> enough to run Santa Tracker, this <a href=\"https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/index.html#L75\">code</a> will be executed.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> supported <span class=\"token operator\">=</span> ignoreCheck <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// feature-detect APIs: limits to IE11+, SF9+</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>window<span class=\"token punctuation\">.</span>performance <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>window<span class=\"token punctuation\">.</span>performance<span class=\"token punctuation\">.</span>now <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>window<span class=\"token punctuation\">.</span>Set <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>history<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// no older Android browser</span>\n  <span class=\"token keyword\">var</span> uaString <span class=\"token operator\">=</span> navigator<span class=\"token punctuation\">.</span>userAgent<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>uaString<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Chrome'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> uaString<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Android'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token regex\">/^Google/</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>navigator<span class=\"token punctuation\">.</span>vendor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// no older Chromium (e.g., Samsung browser fork or ancient install)</span>\n  <span class=\"token keyword\">var</span> chromeVersion <span class=\"token operator\">=</span> <span class=\"token regex\">/Chrome\\/(\\d+)/</span><span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span>uaString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>chromeVersion <span class=\"token operator\">&amp;&amp;</span> chromeVersion<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>chromeVersion<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">44</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>supported<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// fail over to upgrade.html, falling back to timeout in case Analytics is failing.</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> <span class=\"token string\">'upgrade.html'</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>query <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">ga</span><span class=\"token punctuation\">(</span><span class=\"token string\">'send'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pageview'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">ga</span><span class=\"token punctuation\">(</span><span class=\"token string\">'send'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'event'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Polymer'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'unsupported-browser'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> hitCallback<span class=\"token punctuation\">:</span> redirect <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  navigator<span class=\"token punctuation\">.</span>sendBeacon <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>redirect<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<h2><strong>Challenges</strong></h2>\n<p>The size of the Santa Tracker app is rather large, like serveral hundred megabytes large! This is for a few reasons:</p>\n<ul>\n<li>Many assets must be duplicated in order to support multiple languages</li>\n<li>Different media support for different platforms</li>\n<li>Different sizes and resolutions for multimedia files</li>\n</ul>\n<p>In December, the app undergoes frequent updates, which means that <strong>assets already cached by a user’s browser may need to be refreshed on repeat visits.</strong> </p>\n<h2><strong>Using Polymer</strong></h2>\n<p><a href=\"https://github.com/google/santa-tracker-web/blob/master/bower.json#L25\">Santa Tracker is now using <strong>Polymer 1.7</strong></a> (upgraded from 0.5), with a shared set of code including the router, shared navigation assets and so on.</p>\n<p>Each scene uses a different URL and has its own web component. When a user opens a scene, all its required HTML and assets (images, audio, css, js) under <code class=\"language-text\">/scenes/[[sceneName]]</code> are preloaded. Before the loading finishes, a friendly progress bar will show on the page.</p>\n<p><img src=\"https://developers.google.com/web/showcase/2017/images/santa/preloader.gif\" alt=\"Santa preloader\"></p>\n<p>An internal <a href=\"https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/gulp_scripts/file_manifest/index.js\">“cache manifest”</a>, containing all the assets required for every scene, is needed to make the preloading work. This manifest is a JSON file storing a mapping from filename to an MD5 hash of its contents.</p>\n<h3><strong>Load what is used</strong></h3>\n<p>Santa Tracker leverages Polymer’s ability to upgrade custom elements at runtime, rather than at load time.</p>\n<p>Santa Tracker uses <a href=\"https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/elements/santacontroller/santa-app.html#L74\"><code class=\"language-text\">&lt;lazy-pages&gt;</code></a> element to load a scene. The element resolves the scene’s element and <code class=\"language-text\">path</code> attribute, loading the HTML import that contains the Polymer element and its dependent elements.</p>\n<h2>Offline design with service worker</h2>","frontmatter":{"title":"Case Study：Google's Santa Tracker","date":"June 01, 2019","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/googles-santa-tracker/","previous":{"fields":{"slug":"/parseInt/"},"frontmatter":{"title":"Tricky parseInt()"}},"next":null}}