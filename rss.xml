<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Natalie's Blog]]></title><description><![CDATA[A blog by nataliekate, built with Gatsby.js]]></description><link>https://nataliekate.github.io/</link><generator>RSS for Node</generator><lastBuildDate>Sat, 01 Jun 2019 19:50:29 GMT</lastBuildDate><item><title><![CDATA[Case Study：Google's Santa Tracker]]></title><description><![CDATA[来源：Santa Tracker as a PWA去年圣诞节才知道Google弄了个有趣的小应用，叫Santa Tracker，让你实时跟踪圣诞老人的“去向”。当时就觉得太好玩了。今天无聊看了下Google Developers的前端Case Studies…]]></description><link>https://nataliekate.github.io//googles-santa-tracker/</link><guid isPermaLink="false">https://nataliekate.github.io//googles-santa-tracker/</guid><pubDate>Sat, 01 Jun 2019 01:24:00 GMT</pubDate><content:encoded>&lt;p&gt;来源：&lt;a href=&quot;https://developers.google.com/web/showcase/2017/santa&quot;&gt;Santa Tracker as a PWA&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;去年圣诞节才知道Google弄了个有趣的小应用，叫Santa Tracker，让你实时跟踪圣诞老人的“去向”。当时就觉得太好玩了。今天无聊看了下Google Developers的前端Case Studies，发现刚好有一篇关于这个小应用的文章，于是读了一下，希望能汲取大神们的智慧。&lt;/p&gt;
&lt;p&gt;Santa Tracker is an Progressive Web App (PWA) that supports Add to Home Screen (ATHS) and offline. The offline function makes use of the Service Worker API.&lt;/p&gt;
&lt;p&gt;The unique ‘scenes’ on the web version of Santa Tracker is written in &lt;a href=&quot;https://www.polymer-project.org/&quot;&gt;Polymer 1.7.0&lt;/a&gt;, supporting most modern browsers. The app requires ES6 features like &lt;code class=&quot;language-text&quot;&gt;Set&lt;/code&gt; as well as the &lt;strong&gt;Web Performance API&lt;/strong&gt;. To decide whether the browser is &lt;em&gt;modern&lt;/em&gt; enough to run Santa Tracker, this &lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/index.html#L75&quot;&gt;code&lt;/a&gt; will be executed.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; supported &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ignoreCheck &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// feature-detect APIs: limits to IE11+, SF9+&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;performance &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;performance&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;now &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Set &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;history&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// no older Android browser&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; uaString &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; navigator&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;userAgent&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uaString&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;indexOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Chrome&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; uaString&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;indexOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Android&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token regex&quot;&gt;/^Google/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;navigator&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;vendor&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// no older Chromium (e.g., Samsung browser fork or ancient install)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; chromeVersion &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;/Chrome\/(\d+)/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;uaString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;chromeVersion &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; chromeVersion&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;chromeVersion&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;44&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;supported&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;// fail over to upgrade.html, falling back to timeout in case Analytics is failing.&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;redirect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;location &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;upgrade.html&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;location&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;query &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ga&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;send&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;pageview&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ga&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;send&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;event&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Polymer&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;unsupported-browser&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; hitCallback&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; redirect &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  navigator&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sendBeacon &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;redirect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;redirect&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;br&gt;
&lt;h2&gt;&lt;strong&gt;Challenges&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;The size of the Santa Tracker app is rather large, like serveral hundred megabytes large! This is for a few reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Many assets must be duplicated in order to support multiple languages&lt;/li&gt;
&lt;li&gt;Different media support for different platforms&lt;/li&gt;
&lt;li&gt;Different sizes and resolutions for multimedia files&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In December, the app undergoes frequent updates, which means that &lt;strong&gt;assets already cached by a user’s browser may need to be refreshed on repeat visits.&lt;/strong&gt; &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Using Polymer&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/master/bower.json#L25&quot;&gt;Santa Tracker is now using &lt;strong&gt;Polymer 1.7&lt;/strong&gt;&lt;/a&gt; (upgraded from 0.5), with a shared set of code including the router, shared navigation assets and so on.&lt;/p&gt;
&lt;p&gt;Each scene uses a different URL and has its own web component. When a user opens a scene, all its required HTML and assets (images, audio, css, js) under &lt;code class=&quot;language-text&quot;&gt;/scenes/[[sceneName]]&lt;/code&gt; are preloaded. Before the loading finishes, a friendly progress bar will show on the page.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://developers.google.com/web/showcase/2017/images/santa/preloader.gif&quot; alt=&quot;Santa preloader&quot;&gt;&lt;/p&gt;
&lt;p&gt;An internal &lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/gulp_scripts/file_manifest/index.js&quot;&gt;“cache manifest”&lt;/a&gt;, containing all the assets required for every scene, is needed to make the preloading work. This manifest is a JSON file storing a mapping from filename to an MD5 hash of its contents.&lt;/p&gt;
&lt;h3&gt;Load what is used&lt;/h3&gt;
&lt;p&gt;Santa Tracker leverages Polymer’s ability to upgrade custom elements at runtime, rather than at load time.&lt;/p&gt;
&lt;p&gt;Santa Tracker uses &lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/elements/santacontroller/santa-app.html#L74&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;&amp;lt;lazy-pages&amp;gt;&lt;/code&gt;&lt;/a&gt; element to load a scene. The element resolves the scene’s element and &lt;code class=&quot;language-text&quot;&gt;path&lt;/code&gt; attribute, loading the HTML import that contains the Polymer element and its dependent elements.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Offline Design with Service Worker&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;For Santa Tracker, the service worker is in &lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/sw.js&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;sw.js&lt;/code&gt;&lt;/a&gt;, which fires an &lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/sw.js#L207&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;install&lt;/code&gt; event&lt;/a&gt; to precache all shared code, so nothing needs to be fetched at runtime.&lt;/p&gt;
&lt;p&gt;The Service Worker, once installed, is able to intercept all HTTP requests. For Santa Tracker, the simplified decision flow looks like:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Is the request already cached?&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Great! Return the cached response.  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Does the request match a scene directory, like “scenes/boatload/boatload-scene_en.html”?&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Perform a network request, and store the result in the cache before returning it to the user.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Otherwise, perform a regular network request.&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In this way, only the scenes a user has previously loaded will be available offline.&lt;/p&gt;
&lt;p&gt;Every time a new release is deployed, all assets will have a different URL. That’s because each release generates an MD5 hash of every file and store this in the “cache manifest”. This means anything cached by the browser or service worker will be useless.&lt;/p&gt;
&lt;p&gt;To solve this problem, in &lt;code class=&quot;language-text&quot;&gt;index.html&lt;/code&gt; there is code to check for an updated service worker and fetch it. And then the browser will trigger the &lt;code class=&quot;language-text&quot;&gt;install&lt;/code&gt; event again and &lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/master/sw.js#L176&quot;&gt;compare the new “cache manifest” and the old one&lt;/a&gt;. If assets have a different MD5 hash,the cached one will be deleted and the browser will refetch a new one.&lt;/p&gt;
&lt;p&gt;Upgrading the service worker causes a user’s browser to &lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/master/index.html#L159&quot;&gt;immediately reload&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;Browsing offline&lt;/h3&gt;
&lt;p&gt;The app sends regular requests to Santa’s API to check if the user is offline (request fail), instead of using &lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/API/NavigatorOnLine/onLine&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;navigator.onLine&lt;/code&gt;&lt;/a&gt;: this property depends on browser implementation, which may get false status of the network.&lt;/p&gt;
&lt;h3&gt;Localization&lt;/h3&gt;
&lt;p&gt;The app has versions for over 35 languages. Normally, &lt;code class=&quot;language-text&quot;&gt;Accept-Language&lt;/code&gt; header and &lt;a href=&quot;https://github.com/google/santa-tracker-web/blob/280183e37e30f16856e9c238cc6de613f4309fd1/sw.js#L31&quot;&gt;other cues&lt;/a&gt; are used to detect the language to serve. Otherwise, if a user manually choose a new language from the picker, a new version will be fetched. In other words, the version of Santa Tracker is in face a tuple of (build, language).&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Tricky parseInt()]]></title><description><![CDATA[What is the output of:I came across this question during a job interview.Obviously, this was a tricky question. It is easy to presume that…]]></description><link>https://nataliekate.github.io//parseInt/</link><guid isPermaLink="false">https://nataliekate.github.io//parseInt/</guid><pubDate>Mon, 27 May 2019 17:29:00 GMT</pubDate><content:encoded>&lt;p&gt;What is the output of:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;1&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;2&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;3&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parseInt&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I came across this question during a job interview.&lt;/p&gt;
&lt;p&gt;Obviously, this was a tricky question. It is easy to presume that the result would be an array like &lt;code class=&quot;language-text&quot;&gt;[1, 2, 3]&lt;/code&gt; (like I did). However, that’s not the case.&lt;/p&gt;
&lt;p&gt;If you type the expression into the console in your browser, you’ll get the result below:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;NaN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;NaN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;But why?&lt;/p&gt;
&lt;p&gt;&lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3c70b9c4a462a9b136e9f25a4d0f04c8/c35de/why.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 61%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAIAAf/aAAwDAQACEAMQAAABVaY7KTJGP//EABoQAAMBAAMAAAAAAAAAAAAAAAABAgMEERL/2gAIAQEAAQUCvT2LR5i5JOMG8qF2f//EABYRAAMAAAAAAAAAAAAAAAAAABARIf/aAAgBAwEBPwFQf//EABcRAAMBAAAAAAAAAAAAAAAAAAEQERL/2gAIAQIBAT8B3Sv/xAAcEAABAwUAAAAAAAAAAAAAAAABABAREiIzUnH/2gAIAQEABj8CtFK26sYYQ3//xAAcEAACAgIDAAAAAAAAAAAAAAABIQARMVEQgZH/2gAIAQEAAT8hCpNnmUWExAafTKBR9jQLfD//2gAMAwEAAgADAAAAEBj/AP/EABYRAAMAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAwEBPxAyn//EABYRAQEBAAAAAAAAAAAAAAAAAAABEf/aAAgBAgEBPxCQNf/EAB0QAQEAAgIDAQAAAAAAAAAAAAERACExQVFhkYH/2gAIAQEAAT8QBSINFQ+uu/ubxJiOjiSZymfwYKNU23lEo0BZfg+uf//Z&apos;); background-size: cover; display: block;&quot;
    &gt;&lt;/span&gt;
    &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Why&quot;
        title=&quot;&quot;
        src=&quot;/static/3c70b9c4a462a9b136e9f25a4d0f04c8/c739e/why.jpg&quot;
        srcset=&quot;/static/3c70b9c4a462a9b136e9f25a4d0f04c8/8ee9c/why.jpg 148w,
/static/3c70b9c4a462a9b136e9f25a4d0f04c8/ebbe7/why.jpg 295w,
/static/3c70b9c4a462a9b136e9f25a4d0f04c8/c739e/why.jpg 590w,
/static/3c70b9c4a462a9b136e9f25a4d0f04c8/5413e/why.jpg 885w,
/static/3c70b9c4a462a9b136e9f25a4d0f04c8/4efde/why.jpg 1180w,
/static/3c70b9c4a462a9b136e9f25a4d0f04c8/c35de/why.jpg 1200w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
  &lt;/span&gt;
  &lt;/a&gt;&lt;/p&gt;
&lt;p&gt;After reading &lt;a href=&quot;http://www.wirfs-brock.com/allen/posts/166&quot;&gt;Allen Wirfs-Brock’s blog&lt;/a&gt;, I got the answer.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;~~&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;1. How does &lt;code class=&quot;language-text&quot;&gt;parseInt&lt;/code&gt; work?&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;parseInt&lt;/code&gt; is a bulit-in function, which produces a interger value by parsing a string. &lt;/p&gt;
&lt;p&gt;Usually we call the function like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;123&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// n = 123&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;xyz&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// x = NaN&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If the string can be parsed as numeric literal, then &lt;code class=&quot;language-text&quot;&gt;parseInt&lt;/code&gt; will return the number value. Otherwise, the value &lt;code class=&quot;language-text&quot;&gt;NaN&lt;/code&gt; will be returned.&lt;/p&gt;
&lt;p&gt;Looking at the &lt;a href=&quot;http://es5.github.io/#x15.1.2.2&quot;&gt;specification of parseInt&lt;/a&gt; , I noticed that the function receives &lt;strong&gt;2&lt;/strong&gt; arguments, &lt;code class=&quot;language-text&quot;&gt;string&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;radix&lt;/code&gt;. The first argument is the string to be parsed and the second specifics the radix of the number to be parsed. &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// syntax&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; string&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; radix &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// examples&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;100&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 100&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// NaN&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;15&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 13&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;0x16&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 22&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And if &lt;code class=&quot;language-text&quot;&gt;radix&lt;/code&gt; is not given or &lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt;, then it is assumed to be &lt;code class=&quot;language-text&quot;&gt;10&lt;/code&gt;.&lt;/p&gt;
&lt;br&gt;
&lt;br&gt;
&lt;h3&gt;2. How does &lt;code class=&quot;language-text&quot;&gt;Array.prototype.map&lt;/code&gt; work?&lt;/h3&gt;
&lt;p&gt;The &lt;a href=&quot;http://es5.github.io/#x15.4.4.19&quot;&gt;specification of Array.prototype.map&lt;/a&gt; defines the function syntax as below:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; callbackfn &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; thisArg &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;callbackfn&lt;/code&gt; is the first argument passed to &lt;code class=&quot;language-text&quot;&gt;map&lt;/code&gt;. It is called with &lt;em&gt;three&lt;/em&gt; arguments: the value of the element, the index of the element, and the object being traversed. That means &lt;code class=&quot;language-text&quot;&gt;parseInt&lt;/code&gt; is in fact called like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// theArray = [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;]&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; theArray&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; theArray&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; theArray&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;JavaScript functions will ignore extra arguments and, since &lt;code class=&quot;language-text&quot;&gt;parseInt&lt;/code&gt; only expects &lt;strong&gt;2&lt;/strong&gt; arguments, the &lt;code class=&quot;language-text&quot;&gt;theArray&lt;/code&gt; argument will be ignored. But the second argument, which is the index of the array element, works as the &lt;code class=&quot;language-text&quot;&gt;radix&lt;/code&gt; of the &lt;code class=&quot;language-text&quot;&gt;parseInt&lt;/code&gt; function in each call:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// theArray.map(parseInt) -&gt; theArray.map(parseInt(value, index))&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// first iteration (index = 0)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// equals to parseInt(&quot;1&quot;, 10) = 1&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// second iteration (index = 1)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// NaN&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// third iteration (index = 2)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// NaN&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This explains why the result should be [1, NaN, NaN], instead of [1, 2, 3].&lt;/p&gt;
&lt;br&gt;
&lt;br&gt;
&lt;h3&gt;3. How to avoid the problem?&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Rewrite the original expression:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// or&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parseInt&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;However, the above method seems verbose and less elegant.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;br&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Use the &lt;code class=&quot;language-text&quot;&gt;Number&lt;/code&gt; constructor as the &lt;em&gt;callbackFn&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Number&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Number&lt;/code&gt; takes only &lt;strong&gt;1&lt;/strong&gt; argument, and parse it as a decimal number. But unlike &lt;code class=&quot;language-text&quot;&gt;parseInt&lt;/code&gt;, it will also return a float or (resolved) exponential notation.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;1.1&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;2.2e2&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;3e300&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Number&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// [1.1, 220, 3e+300]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[什么是内容协商？]]></title><description><![CDATA[同一个 Web 网站有可能存在着多份相同内容的页面。比如英语版和中文版的 Web 页面，它们内容上虽相同，但使用的语言却不同。当浏览器的默认语言为英语或中文，访问相同 URI 的 Web 页面时，则会显示对应的英语版或中文版的 Web 页面。这样的机制称为内容协商（Content…]]></description><link>https://nataliekate.github.io//content-negotiation/</link><guid isPermaLink="false">https://nataliekate.github.io//content-negotiation/</guid><pubDate>Mon, 20 May 2019 03:09:00 GMT</pubDate><content:encoded>&lt;p&gt;同一个 Web 网站有可能存在着多份相同内容的页面。比如英语版和中文版的 Web 页面，它们内容上虽相同，但使用的语言却不同。当浏览器的默认语言为英语或中文，访问相同 URI 的 Web 页面时，则会显示对应的英语版或中文版的 Web 页面。这样的机制称为&lt;strong&gt;内容协商（Content Negotiation）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;内容协商机制&lt;/strong&gt;是指客户端和服务器端就响应的资源内容进行交涉，然后提供给客户端最为适合的资源。内容协商会以响应资源的&lt;em&gt;语言、字符集、编码方式&lt;/em&gt;等作为判断的基准。通过这个机制，单一的URL可以代表不同的资源（比如一个网站网页的法语版和英语版）。这些不同的版本称为&lt;strong&gt;变体（variants）&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;HTTP提供了多种内容协商机制：&lt;strong&gt;服务器驱动&lt;/strong&gt;（或称主动（proactive））、&lt;strong&gt;客户端驱动/用户代理驱动&lt;/strong&gt;（或称被动（reactive））、&lt;strong&gt;透明（前两者的结合）&lt;/strong&gt;。&lt;/p&gt;
&lt;h2&gt;1. 客户端驱动（Client-Driven）/用户代理驱动（Agent-Driven）&lt;/h2&gt;
&lt;h3&gt;实现原理&lt;/h3&gt;
&lt;p&gt;服务器由两种方法为客户端提供选项：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;发送回一个HTML文档，里面由该页面的各种版本的链接和每个版本的描述信息&lt;/li&gt;
&lt;li&gt;发送回HTTP/1.1的 &lt;code class=&quot;language-text&quot;&gt;300 Multiple Choices&lt;/code&gt; 响应代码&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://mdn.mozillademos.org/files/13795/HTTPNego3.png&quot; alt=&quot;client-driven negotiation image&quot;&gt;&lt;/p&gt;
&lt;p&gt;这种机制下，决定是由客户端用户作出的。&lt;/p&gt;
&lt;h3&gt;缺点&lt;/h3&gt;
&lt;p&gt;这种机制的不利之处在于：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;每个页面都需要两次请求，第一次获取列表，第二次获取选择的副本。这样会减慢内容呈现的速度。&lt;/li&gt;
&lt;li&gt;此外，它还需要多个URL：公共页面要一个，其他每种特殊页面也都要一个。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;2. 服务器驱动（Server-Driven）&lt;/h2&gt;
&lt;p&gt;减少额外通信量的一种方法是让服务器来决定返回哪个页面，但为了做到这一点，客户端需要提供足够的客户偏好信息，以便服务器能准确地作出决策。而这些信息是通过 &lt;strong&gt;客户端请求的首部（client’s request headers）&lt;/strong&gt; 来获取的。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;These headers describe the preferred choice of the user. The server uses them as hints and an internal algorithm chooses the best content to serve to the client. The algorithm is &lt;em&gt;server-specific&lt;/em&gt; and not defined in the standard. (&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation#Server-driven_content_negotiation&quot;&gt;MDN&lt;/a&gt;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://mdn.mozillademos.org/files/13791/HTTPNegoServer.png&quot; alt=&quot;server-driven negotiation image&quot;&gt;&lt;/p&gt;
&lt;p&gt;HTTP服务器发送响应的评估机制有以下这些：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;检查内容协商首部（content-negotiation headers）&lt;/li&gt;
&lt;li&gt;根据其他（非内容协商）首部进行变通：如&lt;code class=&quot;language-text&quot;&gt;User Agent&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;客户端提示（client hints）：目前还是实验性提案（&lt;a href=&quot;https://httpwg.org/http-extensions/client-hints.html&quot;&gt;HTTP Client Hints - Working Group&lt;/a&gt;，  &lt;a href=&quot;https://developers.google.com/web/updates/2015/09/automating-resource-selection-with-client-hints&quot;&gt;Automating Resource Selection with Client Hints - Google Developers&lt;/a&gt; ）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;内容协商首部集&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;首部名称&lt;/th&gt;
&lt;th&gt;描述&lt;/th&gt;
&lt;th&gt;对应的实体首部（entity header）&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code class=&quot;language-text&quot;&gt;Accept&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;告知服务器发送何种媒体类型&lt;/td&gt;
&lt;td&gt;&lt;code class=&quot;language-text&quot;&gt;Content-Type&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code class=&quot;language-text&quot;&gt;Accept-Charset&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;告知服务器发送何种字符集&lt;/td&gt;
&lt;td&gt;&lt;code class=&quot;language-text&quot;&gt;Content-Type&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code class=&quot;language-text&quot;&gt;Accept-Encoding&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;告知服务器采用何种编码&lt;/td&gt;
&lt;td&gt;&lt;code class=&quot;language-text&quot;&gt;Content-Encoding&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code class=&quot;language-text&quot;&gt;Accept-Language&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;告知服务器发送何种语言&lt;/td&gt;
&lt;td&gt;&lt;code class=&quot;language-text&quot;&gt;Content-Language&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;内容协商首部集有对应的实体首部集，这里实体首部集描述了把报文&lt;strong&gt;从服务器端传输给客户端&lt;/strong&gt;的过程中必须的各种报文主体（message body）属性，而内容协商首部集是&lt;strong&gt;由客户端发送给服务器端&lt;/strong&gt;用于交换偏好信息的，以便服务器端可以选择出最符合客户偏好的版本。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;由于HTTP是&lt;strong&gt;无状态的（stateless）&lt;/strong&gt;，服务器端不会在不同请求之间追踪客户端的偏好，因此客户端必须在每个请求中都发送其偏好信息。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;质量值（Quality Values，简称 &lt;code class=&quot;language-text&quot;&gt;q&lt;/code&gt; 值）&lt;/h4&gt;
&lt;p&gt;假设某个客户偏好西班牙语，服务器端只有英语和法语两个版本的页面，此时服务器需要一种机制来确定客户偏好的优先次序。这种机制就叫做&lt;strong&gt;质量值&lt;/strong&gt;，简称 &lt;code class=&quot;language-text&quot;&gt;q&lt;/code&gt; 值（qvalue）。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;q&lt;/code&gt; 值的范围为 0 - 1 间的实数，0.001为优先级最低，1为优先级最高；0代表 “Not Acceptable”。如果没有定义 &lt;code class=&quot;language-text&quot;&gt;q&lt;/code&gt; 值，则默认为1。&lt;/p&gt;
&lt;p&gt;例如&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Accept-Language: en;q=0.5, fr;q=0.001, nl;q=1.0, tr;q=0.0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;随其他首部变化&lt;/h3&gt;
&lt;p&gt;服务器端也可根据其他客户端请求首部来匹配响应。在这种情况下，服务器端返回什么取决于其实现方式。&lt;/p&gt;
&lt;p&gt;比如 &lt;code class=&quot;language-text&quot;&gt;User-Agent&lt;/code&gt; 例如有些浏览器不支持JavaScript，就可以向其发送不含有JavaScript的页面版本，不过这种做法不提倡使用。&lt;/p&gt;
&lt;p&gt;响应中通常会发送 &lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 首部，来说明实际上哪些消息头被用作内容协商的参考依据（确切来说是与之相关的响应消息头），这样可以使缓存的运作更有效。&lt;/p&gt;
&lt;h4&gt;&lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 用于动态服务&lt;/h4&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 是一个HTTP响应头部信息，它决定了对于未来的一个请求头，应该用一个缓存的回复(response)还是向源服务器请求一个新的回复。&lt;/p&gt;
&lt;p&gt;与前面列举的 &lt;code class=&quot;language-text&quot;&gt;Accept-*&lt;/code&gt; 形式的由客户端发送的首部相反，&lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 首部是由服务器在响应中发送的。它标示了服务器在服务端驱动型内容协商阶段所使用的首部清单。这个首部是必要的，它可以用来通知缓存服务器决策的依据，这样它可以进行复现，使得缓存服务器在预防将错误内容提供给用户方面发挥作用。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;When using the &lt;code class=&quot;language-text&quot;&gt;Vary: User-Agent&lt;/code&gt; header, caching servers should consider the user agent when deciding whether to serve the page from cache.
For example, if you are serving different content to mobile users, it can help you to avoid that a cache may mistakenly serve a desktop version of your site to your mobile users.
It can help Google and other search engines to discover the mobile version of a page, and might also tell them that no Cloaking is intended.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Vary: User-Agent&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;服务器端扩展&lt;/h3&gt;
&lt;p&gt;另一种在服务器端实现内容协商的方法是使用服务器端扩展，比如微软的&lt;a href=&quot;https://en.wikipedia.org/wiki/ASP.NET&quot;&gt;ASP.NET&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;缺点&lt;/h3&gt;
&lt;p&gt;Proactive negotiation has serious disadvantages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;服务器对浏览器并非全知全能。即便是有了客户端示意扩展，也依然无法获取关于浏览器能力的全部信息。与客户端进行选择的代理驱动型内容协商机制不同，服务器端的选择总是显得有点武断。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;It is &lt;strong&gt;impossible&lt;/strong&gt; for the server to accurately determine what might be &lt;strong&gt;“best”&lt;/strong&gt; for any given user, since that would require complete knowledge of both the capabilities of the user agent and the intended use for the response (e.g., does the user want to view it on screen or print it on paper?); &lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;客户端提供的信息相当冗长（HTTP/2 协议的首部压缩机制缓解了这个问题），并且存在隐私风险（HTTP 指纹识别技术）。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Having the user agent describe its capabilities in every request can be both very &lt;strong&gt;inefficient&lt;/strong&gt; (given that only a small percentage
of responses have multiple representations) (&lt;a href=&quot;https://tools.ietf.org/html/rfc7541&quot;&gt;HTTP/2 header compression&lt;/a&gt; mitigates this problem)  and a potential risk to the user’s privacy (&lt;a href=&quot;http://www.net-square.com/httprint_paper.html&quot;&gt;HTTP fingerprinting&lt;/a&gt;);&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;因为给定的资源需要返回不同的展现形式，共享缓存的效率会降低，而服务器端的实现会越来越复杂。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;It complicates the implementation of an origin server and the algorithms for generating responses to a request; and, &lt;br&gt; It limits the reusability of responses for shared caching (several representations of a given resource are sent)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;3. 透明（Transparent）&lt;/h2&gt;
&lt;p&gt;透明协商机制试图减轻服务器驱动协商中服务器的负载，并用&lt;strong&gt;中间代理&lt;/strong&gt;来代表客户端，以使与客户端的报文交换最小化。
&lt;br&gt;
假定代理了解客户端的预期，这样就可以代表客户端与服务器协商。
&lt;br&gt;
服务器必须有能力告知代理，需要检查哪些请求首部（request headers），以便进行最佳匹配。&lt;/p&gt;
&lt;h3&gt;代理缓存（Caching Proxies）&lt;/h3&gt;
&lt;p&gt;代理缓存可以为通过单个URL访问的文档保存不同的副本，这些不同的版本称为 &lt;em&gt;变体（variant）&lt;/em&gt; 或者 &lt;em&gt;备用候选（alternate）&lt;/em&gt; 。服务器把它们的决策逻辑、&lt;code class=&quot;language-text&quot;&gt;Accept&lt;/code&gt; 首部集等传给缓存，这样代理就可以代表服务器与客户端进行协商。同时缓存也可以对内容进行转码。&lt;/p&gt;
&lt;h3&gt;使用 &lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 首部&lt;/h3&gt;
&lt;p&gt;HTTP/1.1定义了 &lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 首部。服务器在响应中发送 &lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 首部，以告知中间节点需要使用哪些请求首部进行内容协商。&lt;br&gt;
在之前提到的代理缓存中，如果服务器的决策依据不是 &lt;code class=&quot;language-text&quot;&gt;Accept&lt;/code&gt; 首部集，而是其他（如 &lt;code class=&quot;language-text&quot;&gt;User-Agent&lt;/code&gt; ）的话，缓存必须知道这些首部是什么，这样才能作出正确的判断。例如，所提供的文档取决于 &lt;code class=&quot;language-text&quot;&gt;User-Agent&lt;/code&gt; ，&lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 首部就必须包括 &lt;code class=&quot;language-text&quot;&gt;User-Agent&lt;/code&gt; &lt;br&gt;&lt;/p&gt;
&lt;p&gt;当新的请求到达时，缓存会根据 &lt;code class=&quot;language-text&quot;&gt;Accept-*&lt;/code&gt; 首部集来寻找最佳匹配。然而在把文档提供给客户端之前，它必须检查服务器端有没有在&lt;strong&gt;已缓存响应&lt;/strong&gt;中发送过 &lt;code class=&quot;language-text&quot;&gt;Vary&lt;/code&gt; 首部。如果有，则新请求中的那些首部的值必须与&lt;strong&gt;已缓存请求&lt;/strong&gt;里对应的首部相同。如果无法匹配，则从服务器获取文档。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;参考链接：
&lt;br&gt;
&lt;a href=&quot;https://tools.ietf.org/html/rfc7231#section-5.3&quot;&gt;RFC 7231 - 5.3. Content Negotiation&lt;/a&gt;
&lt;br&gt;
&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation&quot;&gt;Content negotiation - HTTP | MDN&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[HTTP Message vs. HTTP Entity]]></title><description><![CDATA[HTTP报文 vs. HTTP实体Request and Response messages MAY transfer an entity if not otherwise restricted by the request method or response status…]]></description><link>https://nataliekate.github.io//message_vs_entity/</link><guid isPermaLink="false">https://nataliekate.github.io//message_vs_entity/</guid><pubDate>Sun, 19 May 2019 23:53:00 GMT</pubDate><content:encoded>&lt;h2&gt;HTTP报文 vs. HTTP实体&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Request and Response messages MAY transfer an entity if not otherwise restricted by the request method or response status code. An entity consists of entity-header fields and an entity-body, although some responses will only include the entity-headers. (&lt;a href=&quot;https://www.w3.org/Protocols/rfc2616/rfc2616-sec7.html&quot;&gt;RFC 2616 - section 7&lt;/a&gt;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;HTTP在传输数据时可以按照数据原貌直接传输，也可以通过编码提升传输速率。&lt;/p&gt;
&lt;p&gt;在传输时编码，能安全有效的处理大量的访问请求，但同时也会消耗更多的资源（CPU等），因为编码操作需要计算机来完成。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;报文（Message）&lt;/strong&gt; 是HTTP通信中的基本单位，由8位组字节流（octet sequence，octet是指八个比特（bit）为一组的单位）。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;实体（Entity）&lt;/strong&gt; 作为请求或响应的有效载荷数据（补充项）被传输，内容由实体首部和实体主体组成。&lt;/p&gt;
&lt;p&gt;在请求方法或响应状态码没有限制的情况下，报文可以用于传输实体。&lt;/p&gt;
&lt;h2&gt;报文主体 vs. 实体主体&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;The &lt;strong&gt;message-body&lt;/strong&gt; (if any) of an HTTP message is used to carry the &lt;strong&gt;entity-body&lt;/strong&gt; associated with the request or response. The message-body differs from the entity-body &lt;strong&gt;only when&lt;/strong&gt; a &lt;strong&gt;transfer-coding&lt;/strong&gt; has been applied, as indicated by the &lt;code class=&quot;language-text&quot;&gt;Transfer-Encoding&lt;/code&gt; header field. (&lt;a href=&quot;https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html&quot;&gt;RFC 2616 - section 4&lt;/a&gt;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt; The &lt;strong&gt;entity-body&lt;/strong&gt; is obtained from the &lt;strong&gt;message-body&lt;/strong&gt; by &lt;em&gt;decoding&lt;/em&gt; any Transfer-Encoding that might have been applied to ensure safe and proper transfer of the message.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;报文主体用来传输请求或响应的实体主体，通常情况下两者相同。只有当进行了传输编码时，两者才有差异。此时会使用到&lt;code class=&quot;language-text&quot;&gt;TE&lt;/code&gt;或&lt;code class=&quot;language-text&quot;&gt;Transfer-Encoding&lt;/code&gt;头部，来描述使用了何种编码，使用编码可确保报文传输的安全性和准确性。实体主体由报文主体解码所得。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;message-body = entity-body
              | &amp;lt;entity-body encoded as per Transfer-Encoding&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;// request message
GET /new_products.html HTTP/1.1
Host: www.joes-hardware.com
TE: chunked
...

// response message
HTTP/1.1 200 OK
Transfer-Encoding: chunked
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;HTTP实体首部（Entity Headers）&lt;/h2&gt;
&lt;p&gt;HTTP使用了&lt;strong&gt;实体首部&lt;/strong&gt;来描述HTTP报文的内容。&lt;/p&gt;
&lt;p&gt;HTTP/1.1定义了10个基本实体头部字段：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;entity-header  = Allow                    ;
                | Content-Encoding        ;
                | Content-Language        ;
                | Content-Length          ;
                | Content-Location        ;
                | Content-MD5             ;
                | Content-Range           ;
                | Content-Type            ;
                | Expires                 ;
                | Last-Modified           ;
                | 其他 message-header&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;HTTP实体主体&lt;/h2&gt;
&lt;p&gt;实体主体随HTTP请求和响应发送，其格式和编码由实体首部定义。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;entity-body = *OCTET&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;类型&lt;/h3&gt;
&lt;p&gt;实体主体的数据类型是由 &lt;code class=&quot;language-text&quot;&gt;Content-Type&lt;/code&gt; 和 &lt;code class=&quot;language-text&quot;&gt;Content-Encoding&lt;/code&gt; 两个首部字段决定的。&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Content-Type&lt;/code&gt; 定义数据的类型。
&lt;code class=&quot;language-text&quot;&gt;Content-Encoding&lt;/code&gt; 用来说明应用在数据上的编码方法（通常用于压缩数据），没有默认的编码方法。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Any HTTP/1.1 message containing an entity-body SHOULD include a Content-Type header field defining the media type of that body. If and only if the media type is not given by a Content-Type field, the recipient MAY attempt to guess the media type via inspection of its content and/or the name extension(s) of the URI used to identify the resource. If the media type remains unknown, the recipient SHOULD treat it as type “application/octet-stream”. (&lt;a href=&quot;https://www.w3.org/Protocols/rfc2616/rfc2616-sec7.html&quot;&gt;RFC 2616 - section 7&lt;/a&gt;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;长度&lt;/h3&gt;
&lt;p&gt;The entity-length of a message is the length of the message-body before any transfer-codings have been applied. (&lt;a href=&quot;https://www.w3.org/Protocols/rfc2616/rfc2616-sec7.html&quot;&gt;RFC 2616 - section 7&lt;/a&gt;)&lt;/p&gt;</content:encoded></item><item><title><![CDATA[RESTful API?]]></title><description><![CDATA[What is RESTREST is acronym REpresentational State Transfer. It is an architectural style, or design pattern, for APIs. It was first…]]></description><link>https://nataliekate.github.io//restful_api/</link><guid isPermaLink="false">https://nataliekate.github.io//restful_api/</guid><pubDate>Sun, 19 May 2019 01:59:00 GMT</pubDate><content:encoded>&lt;h2&gt;What is REST&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;REST is acronym &lt;strong&gt;RE&lt;/strong&gt;presentational &lt;strong&gt;S&lt;/strong&gt;tate &lt;strong&gt;T&lt;/strong&gt;ransfer. It is an architectural style, or design pattern, for APIs. It was first presented by Roy Fielding in 2000.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;REST vs. RESTful&lt;/h2&gt;
&lt;p&gt;RESTful is typically used to refer to web services implementing REST architecture.&lt;/p&gt;
&lt;p&gt;Web services that conform to the REST architectural style, called &lt;em&gt;RESTful&lt;/em&gt; Web services (RWS).&lt;/p&gt;
&lt;p&gt;It means when a RESTful API is called, the server will &lt;em&gt;transfer&lt;/em&gt; to the client a &lt;em&gt;representation&lt;/em&gt; of the &lt;em&gt;state&lt;/em&gt; of the requested resource.&lt;/p&gt;
&lt;p&gt;The representation of the state can be in a JSON format, and probably for most APIs this is indeed the case. It can also be in XML or HTML format.&lt;/p&gt;
&lt;p&gt;What the server does when the client calls the API depends on 2 things it provides:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;An &lt;em&gt;identifier&lt;/em&gt; for the resource: URL for the resource, known as the &lt;strong&gt;endpoint&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;em&gt;operation&lt;/em&gt; you want the server to perform on the resource: an &lt;strong&gt;HTTP method&lt;/strong&gt; or a &lt;strong&gt;verb&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;RESTful Web Services&lt;/h3&gt;
&lt;p&gt;HTTP-based RESTful APIs are defined with the following aspects:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;a &lt;strong&gt;base URI&lt;/strong&gt;, such as &lt;code class=&quot;language-text&quot;&gt;http://api.example.com/collection/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;standard &lt;strong&gt;HTTP methods&lt;/strong&gt; (e.g., &lt;code class=&quot;language-text&quot;&gt;GET&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;POST&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;PUT&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;PATCH&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;DELETE&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;a &lt;strong&gt;media type&lt;/strong&gt; that defines state transition data elements (e.g., Atom, microformats, application/vnd.collection+json, etc.)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Architectural Constraints&lt;/h2&gt;
&lt;p&gt;REST defines 6 architectural constraints which make any web service – a true RESTful API.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Client-server architecture&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Seperate user interface from data storage, meaning that client application and server application MUST be able to evolve separately without any dependency on each other.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Stateless&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The client-server communication is constrained by no client context being stored on the server between requests.&lt;/p&gt;
&lt;p&gt;Each request from any client contains all the information necessary to service the request, and session state is kept entirely in the client.&lt;/p&gt;
&lt;p&gt;The session state can be transferred by the server to another service such as a database to maintain a persistent state for a period and allow authentication.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Cacheable&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Cache constraints require that the data within a response to a request be implicitly or explicitly labeled as cacheable or non-cacheable. &lt;/p&gt;
&lt;p&gt;The advantage of adding cache constraints is that they have the potential to partially or completely eliminate some interactions, improving efficiency, scalability, and user-perceived performance by reducing the average latency of a series of interactions. &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Uniform interface&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The uniform interface constraint is &lt;strong&gt;fundamental&lt;/strong&gt; to the design of any RESTful system. It simplifies and decouples the architecture, which enables each part to evolve independently.&lt;/p&gt;
&lt;p&gt;REST is defined by &lt;em&gt;four&lt;/em&gt; interface constraints: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;identification of resources:&lt;/p&gt;
&lt;p&gt;for example using URIs or URNs.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;manipulation of resources through representations: &lt;/p&gt;
&lt;p&gt;A representation consists of data, metadata describing the data, and, on occasion, metadata to describe the metadata (usually for the purpose of verifying message integrity). Other commonly used but less precise names for a representation include: document, file, and HTTP message entity, instance, or variant.&lt;/p&gt;
&lt;p&gt;The data format of a representation is known as a &lt;strong&gt;media type&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;When a client holds a representation of a resource, including any metadata attached, it has enough information to modify or delete the resource.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;self-descriptive messages:&lt;/p&gt;
&lt;p&gt;Each message includes enough information to describe how to process the message. &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;hypermedia as the engine of application state(&lt;a href=&quot;https://restfulapi.net/hateoas/&quot;&gt;HATEOAS&lt;/a&gt;):&lt;/p&gt;
&lt;p&gt;Whenever relevant, a resource should contain links (HATEOAS) pointing to relative URIs to fetch related information.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Layered system&lt;/p&gt;
&lt;p&gt;A client cannot ordinarily tell whether it is connected directly to the end server, or to an intermediary along the way. Intermediary servers can improve system scalability by enabling load balancing and by providing shared caches. They can also enforce security policies.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Code on demand (optional)&lt;/p&gt;
&lt;p&gt;Most of the time you will be sending the static representations of resources in form of XML or JSON. But when you need to, you are free to return executable code to support a part of your application: for example, compiled components such as Java applets, or client-side scripts such as JavaScript.&lt;/p&gt;
&lt;p&gt;Allowing features to be downloaded after deployment improves system extensibility. However, it also reduces visibility, and thus is only an optional constraint within REST.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[rebase和merge的区别]]></title><description><![CDATA[参考官方手册在 Git 中整合来自不同分支的修改主要有两种方法：merge 以及 rebase。假设这种情况：在不同的branch上各自有新的commit（fig1）。fig1整合分支最简单的方法是命令。它会把两个branch的最新的snapshot（C3,C…]]></description><link>https://nataliekate.github.io//rebase_merge/</link><guid isPermaLink="false">https://nataliekate.github.io//rebase_merge/</guid><pubDate>Tue, 07 May 2019 17:29:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA&quot;&gt;参考官方手册&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在 Git 中整合来自不同分支的修改主要有两种方法：merge 以及 rebase。&lt;/p&gt;
&lt;p&gt;假设这种情况：在不同的branch上各自有新的commit（fig1）。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://git-scm.com/book/en/v2/images/basic-rebase-1.png&quot; alt=&quot;fig1&quot;&gt;&lt;/p&gt;
&lt;p&gt;整合分支最简单的方法是&lt;code class=&quot;language-text&quot;&gt;merge&lt;/code&gt;命令。它会把两个branch的最新的snapshot（C3,C4）以及两者最近的共同祖先（C2）进行三方合并。结果是生成（并提交）一个新的snapshot（C5）(fig2)。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://git-scm.com/book/en/v2/images/basic-rebase-2.png&quot; alt=&quot;fig2&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;rebase&lt;/code&gt;是另一种整合的方法。即：提取在C4中引入的修改，然后在C3的基础上应用一次。&lt;/p&gt;
&lt;p&gt;使用&lt;code class=&quot;language-text&quot;&gt;rebase&lt;/code&gt;命令将提交到某个branch上的修改都移至另一个branch上。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ git checkout experiment
$ git rebase master
First, rewinding head to replay your work on top of it...
Applying: added staged command&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;https://git-scm.com/book/en/v2/images/basic-rebase-3.png&quot; alt=&quot;fig3&quot;&gt;&lt;/p&gt;
&lt;p&gt;原理是首先找到两个branch的最近共同祖先（C2），然后对比当前分支相对于祖先的历次提交，提取相应的修改并存为临时文件，然后将当前分支指向目标base（C3）, 最后以此将之前另存为临时文件的修改依序应用。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ git checkout master
$ git merge experiment&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;https://git-scm.com/book/en/v2/images/basic-rebase-4.png&quot; alt=&quot;fig4&quot;&gt;&lt;/p&gt;
&lt;p&gt;在master branch进行快进合并。&lt;/p&gt;
&lt;p&gt;这两种整合方法最终令C4’和C5指向的snapshot是一样的。最终结果没有任何区别，但&lt;code class=&quot;language-text&quot;&gt;rebase&lt;/code&gt;使得提交历更加简洁。&lt;/p&gt;
&lt;p&gt;一般使用&lt;code class=&quot;language-text&quot;&gt;rebase&lt;/code&gt;的目的是确保能保持整洁的提交历史。&lt;/p&gt;
&lt;p&gt;在这种情况下，你首先在自己的分支里进行开发，当开发完成时你需要先将你的代码&lt;code class=&quot;language-text&quot;&gt;rebase&lt;/code&gt;到 &lt;code class=&quot;language-text&quot;&gt;origin/master&lt;/code&gt; 上，然后再向主项目提交修改。 这样的话，该项目的维护者就不再需要进行整合工作，只需要快进合并便可。&lt;/p&gt;
&lt;p&gt;请注意，无论是通过变基，还是通过三方合并，整合的最终结果所指向的快照始终是一样的，只不过提交历史不同罢了。 &lt;strong&gt;变基是将一系列提交按照原有次序依次应用到另一分支上，而合并是把最终结果合在一起。&lt;/strong&gt;&lt;/p&gt;</content:encoded></item></channel></rss>